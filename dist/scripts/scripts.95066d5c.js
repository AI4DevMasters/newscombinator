"use strict";angular.module("agrgtrApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","config","ui.bootstrap","angular-loading-bar","duScroll","infinite-scroll","truncate","angularMoment"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/top.html",controller:"TopCtrl",reloadOnSearch:!0}).when("/about",{templateUrl:"views/about.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",b.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var c=function(a){var b,d,e,f,g,h,i,j="";for(b in a)if(d=a[b],d instanceof Array)for(i=0;i<d.length;++i)g=d[i],e=b+"["+i+"]",h={},h[e]=g,j+=c(h)+"&";else if(d instanceof Object)for(f in d)g=d[f],e=b+"["+f+"]",h={},h[e]=g,j+=c(h)+"&";else void 0!==d&&null!==d&&(j+=encodeURIComponent(b)+"="+encodeURIComponent(d)+"&");return j.length?j.substr(0,j.length-1):j};b.defaults.transformRequest=[function(a){return angular.isObject(a)&&"[object File]"!==String(a)?c(a):a}]}]).directive("navAutoClose",function(){return function(a,b){var c=$(b).find(".navbar-collapse"),d=!1;c.on("show.bs.collapse",function(){d=!0}),c.on("hide.bs.collapse",function(){d=!1}),$(b).find("a").each(function(a,b){$(b).click(function(){d&&"auto"==c.css("overflow-y")&&c.collapse("hide")})})}}),angular.module("config",[]).constant("ENV",{name:"NAgrgtr",apiEndpoint:"http://www.newscombinator.com/api/",trainsamples:10}),angular.module("agrgtrApp").controller("TopCtrl",["$scope","TopnewsService","$location","$routeParams","$route","$window","amTimeAgoConfig",function(a,b,c,d,e,f,g){a.collapsed={},a.collapsed.mobile_menu=!0,a.collapsed.sources=!0,a.collapsed.top_entities=!0,a.collapsed.top_tags=!0,"qs"in d?(b.query=angular.fromJson(d.qs),"dates"in b.query&&("from_date"in b.query.dates&&null!=b.query.dates.from_date&&(b.query.dates.from_date=new Date(b.query.dates.from_date)),"to_date"in b.query.dates&&null!=b.query.dates.to_date&&(b.query.dates.to_date=new Date(b.query.dates.to_date)))):b.reset(),"ranking"in d?(a.ranking=angular.fromJson(d.ranking),a.collapsed.ranking_custom="custom"==a.ranking?!1:!0):(a.ranking="top",a.collapsed.ranking_custom=!0),b.loadNews(!0),a.getResults=function(){return b.results},a.date=b.query.dates,a.q=b.query.custom,a.importancy=b.query.importancy,a.sources=b.query.sourcelinks,a.toggleCollapsed=function(c,d){1==d?(c.hide_titlelinks=!0,a.collapsed[c.id]=!1,b.fetchSimilarToArticle(c),b.fetchSourceitems(c)):c.id in a.collapsed&&!a.collapsed[c.id]?(c.sourceitems=void 0,c.hide_titlelinks=void 0,a.collapsed[c.id]=!a.collapsed[c.id]):(c.hide_titlelinks=!0,a.collapsed[c.id]=!1,b.fetchSimilarToArticle(c),b.fetchSourceitems(c))},a.nextPage=function(){g.serverTime=(new Date).getTime(),b.nextPage()},a.getTopEntities=function(){return b.entities},a.getTopSentiments=function(){return b.sentiments},a.getTopTags=function(){return b.tags},a.addEntity=function(c){b.addEntity(c),a.startSearch()},a.addTag=function(c){b.addTag(c),a.startSearch()},a.getSelectedEntities=function(){return b.query.entities},a.getSelectedTags=function(){return b.query.tags},a.removeEntity=function(c){b.removeEntity(c),a.startSearch()},a.removeTag=function(c){b.removeTag(c),a.startSearch()},a.setQuery=function(b){a.q=b,a.startSearch()},a.setStartDate=function(b){a.date.from_date=b,a.startSearch()},a.setEndDate=function(b){a.date.to_date=b,a.startSearch()},a.toolTipContentFunction=function(a){console.log(a)},a.isLoading=function(){return b.siteState.loading},a.reloadData=function(){e.reload()},a.getJsonLink=function(){return"http://nagrgtr.com/api/search/?dismax=0&highlight=0&only_newest_similar=0&rows=30&q="+escape(b.getQueryString())},a.startSearch=function(){g.serverTime=(new Date).getTime(),b.query.custom=a.q,c.search({qs:angular.toJson(b.query),ranking:angular.toJson(a.ranking)})},a.resetData=function(){b.reset(),c.search({qs:angular.toJson(b.query)})},a.chartEntityXFunction=function(a){return-2==a.key?"Very Bad News":-1==a.key?"Bad News":0==a.key?"Neutral News":1==a.key?"Good News":2==a.key?"Very Good News":void 0},a.chartEntityYFunction=function(a){return a.val},a.open=function(b,c){b.preventDefault(),b.stopPropagation(),void 0==a.opened&&(a.opened={}),a.opened[c]=!0},a.setRanking=function(b){a.ranking=b}}]),angular.module("agrgtrApp").service("TopnewsService",["SearchResource","SourceitemsResource","$q",function(a,b,c){var d=this;d.start=0,d.siteState={loading:!1},d.topEntities=[],d.news=[],d.getQueryString=function(){for(var a='( _val_:"log(add(1,hn_num_points))"^'+2.5*d.query.importancy.points+' _val_:"log(add(1,similar_doc_ids_count_i))"^'+5*d.query.importancy.similar+' _val_:"recip(ms(NOW/HOUR,created_at),3.16e-11,2300,1)"^'+d.query.importancy.age+")",b=0;b<d.query.entities.length;b++)a+=' +named_entities:"'+d.query.entities[b]+'"';for(b=0;b<d.query.tags.length;b++)a+=" +content_analyze:"+d.query.tags[b];if("sourcelinks"in d.query){var c=!1;for(b=0;b<d.query.sourcelinks.length;b++)1==d.query.sourcelinks[b].checked&&(c||(a+=" AND (",c=!0),a+=" source_links:*"+d.query.sourcelinks[b].host+"*");c&&(a+=" )")}return d.query.custom.length>0&&(a+=" "+d.query.custom+" "),(d.query.dates.from_date instanceof Date||d.query.dates.to_date instanceof Date)&&(a+=" AND (created_at:[",a+=d.query.dates.from_date instanceof Date?d.query.dates.from_date.toISOString():"*",a+=" TO ",a+=d.query.dates.to_date instanceof Date?d.query.dates.to_date.toISOString():"*",a+="])"),a},d.groupBySimilar=function(){return""==d.query.custom?"1":"0"},d.getLoading=function(){return d.siteState.loading},d.fetchSimilarToArticle=function(b){"similar_docs"in b&&null!=b.similar_docs||a.query({q:"{!join from=similar_doc_ids to=id}id:"+b.id,dismax:0,highlight:0,only_newest_similar:0,rows:30,order_by_desc:"created_at"},function(a){b.similar_docs=a.response.docs})},d.fetchSourceitems=function(a){"sourceitems"in a&&null!=a.sourceitems||b.query({id:a.id},function(b){a.sourceitems=b})},d.getTopEntities=function(b){if(!("$promise"in d.topEntities)||b){var c={q:d.getQueryString(),"fq[1]":"newest_similar_doc:true",facet:"1",highlight:"0",dismax:0,rows:0};""==d.query.custom&&0==d.query.entities.length&&(c["fq[2]"]="created_at:[NOW/DAY TO *]"),d.topEntities=a.query(c,function(a){for(var b=[],c=[],e=[],f=a.facet_counts.facet_fields.entities,g=0,h=0;h<f.length;h+=2){var i={};if(0==h&&(g=f[h+1]),i.key=f[h],i.val=f[h+1],i.perc=100*f[h+1]/g,b.push(i),h>30)break}for(f=a.facet_counts.facet_fields.keywords,g=0,h=0;h<f.length;h+=2){var j={};if(0==h&&(g=f[h+1]),j.key=f[h],j.val=f[h+1],j.perc=100*f[h+1]/g,c.push(j),h>50)break}for(f=a.facet_counts.facet_ranges.sentiment.counts,h=0;h<f.length;h+=2){var i={};i.key=f[h],i.val=f[h+1],e.push(i)}d.sentiments=e,d.entities=b,d.tags=c})}return d.topEntities.$promise},d.loadNews=function(b){d.siteState.loading=!0;var e=c.defer();return"$promise"in d.news&&!b||(d.news=a.query({q:d.getQueryString(),dismax:0,highlight:0,only_newest_similar:d.groupBySimilar(),rows:30})),d.news.$promise.then(function(a){d.results=a.response.docs,d.start=a.response.docs.length,d.numFound=a.response.numFound,d.maxScore=a.response.maxScore,d.siteState.loading=!1,d.getTopEntities(b),e.resolve(d.results)},function(){e.reject()}),e.promise},d.getQueryEntities=function(){return d.query.entities},d.removeEntity=function(a){void 0!=d.query.entities[a]&&d.query.entities.splice(a,1)},d.addEntity=function(a){var b=!0;return angular.forEach(d.query.entities,function(c){c==a&&(b=!1)}),b?(d.query.entities.push(a),!0):!1},d.getResults=function(){return d.results},d.setQuery=function(a){d.query.custom=a},d.getQueryTags=function(){return d.query.tags},d.removeTag=function(a){void 0!=d.query.tags[a]&&d.query.tags.splice(a,1)},d.addTag=function(a){var b=!0;return angular.forEach(d.query.tags,function(c){c==a&&(b=!1)}),b?(d.query.tags.push(a),!0):!1},d.getResults=function(){return d.results},d.setQuery=function(a){d.query.custom=a},d.nextPage=function(){0==d.siteState.loading&&d.start<d.numFound&&(d.start+=10,d.siteState.loading=!0,a.query({q:d.getQueryString(),start:d.start,dismax:0,highlight:0,only_newest_similar:d.groupBySimilar()},function(a){for(var b=a.response.docs,c=0;c<b.length;c++)d.results.push(b[c]);d.siteState.loading=!1}))},d.reset=function(){d.query={},d.query.entities=[],d.query.tags=[],d.query.custom="",d.query.dates={from_date:null,to_date:null},d.query.importancy={points:2.5,similar:2.5,age:2.5},d.query.sourcelinks=[{host:"ycombinator.com",checked:0},{host:"/r/algorithms",checked:0},{host:"/r/analytics",checked:0},{host:"/r/angularjs",checked:0},{host:"/r/BSD",checked:0},{host:"/r/linux",checked:0},{host:"/r/linuxadmin",checked:0},{host:"/r/linuxdev",checked:0},{host:"/r/Bitcoin",checked:0},{host:"coinspotting",checked:0},{host:"/r/Entrepreneur",checked:0},{host:"/r/crypto",checked:0},{host:"/r/MachineLearning",checked:0},{host:"/r/dataisbeautiful",checked:0},{host:"datatau",checked:0},{host:"devmaster.net",checked:0},{host:"dzone.com",checked:0},{host:"echojs.com",checked:0},{host:"/r/webdev",checked:0},{host:"/r/web_design",checked:0},{host:"pullup.io",checked:0},{host:"lobste.rs",checked:0},{host:"slashdot.org",checked:0},{host:"soylentnews.org",checked:0},{host:"firespotting.com",checked:0},{host:"woodspotting.com",checked:0}]}}]),angular.module("agrgtrApp").factory("SearchResource",["$resource","ENV",function(a,b){return a(b.apiEndpoint+"search/",{},{query:{isArray:!1}})}]),angular.module("agrgtrApp").factory("TopnewsResource",["$resource","ENV",function(a,b){return a(b.apiEndpoint+"search/topsimilar/")}]),angular.module("agrgtrApp").factory("SourceitemsResource",["$resource","ENV",function(a,b){return a(b.apiEndpoint+"search/sourceitems/")}]),angular.module("agrgtrApp").directive("ngModelOnblur",function(){return{restrict:"A",require:"ngModel",priority:1,link:function(a,b,c,d){"radio"!==c.type&&"checkbox"!==c.type&&(b.unbind("input").unbind("keydown").unbind("change"),b.bind("mouseup touchend blur",function(){a.$apply(function(){d.$setViewValue(b.val())})}))}}}),angular.module("agrgtrApp").filter("pad",function(){return function(a){return a+="",a.length>=10?a:new Array(10-a.length+1).join("0")+a}}),angular.module("agrgtrApp").filter("getfavicon",function(){return function(a){var b=document.createElement("a");b.href=a;var c="favicon.ico";return-1!=b.hostname.indexOf("makerland")&&(c="static/img/makerland_favicon_SMALL.ico"),-1!=b.hostname.indexOf("soylentnews")&&(c="favicon-soylentnews.png"),-1!=b.hostname.indexOf("inbound")&&(c="assets/sites/inbound/img/fav.ico"),b.protocol+"//"+b.hostname+"/"+c}}),angular.module("agrgtrApp").filter("showtitle",["$filter",function(a){return function(b,c){return""!=b.title_website&&null!=b.title_website&&-1==b.title_website.indexOf("Firespotting! Interesting Ideas, Every Day!")?void 0!=c?a("highlight")(b.title_website,c,b.id,"title_website"):b.title_website:""!=b.title_link&&null!=b.title_link?b.title_link:b.url}}]),angular.module("agrgtrApp").filter("mysqldate",function(){return function(a){if(a instanceof Date)return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2);if("string"==typeof a){var b=a.split(/[- :]/);return b.length>3?new Date(parseInt(b[0]),parseInt(b[1])-1,parseInt(b[2]),parseInt(b[3]),parseInt(b[4]),parseInt(b[5])):new Date(parseInt(b[0]),parseInt(b[1])-1,parseInt(b[2]))}}}),angular.module("agrgtrApp").filter("mysqlDatetime",function(){return function(a){if(a instanceof Date)return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2);if("string"==typeof a){var b=a.split(/[- :]/);return new Date(parseInt(b[0]),parseInt(b[1])-1,parseInt(b[2]),parseInt(b[3]),parseInt(b[4]),parseInt(b[5]))}}}),angular.module("agrgtrApp").filter("gethostname",function(){return function(a,b){if(-1!=a.indexOf("reddit")&&void 0!=b)return a.replace("http://www.","");var c=document.createElement("a");return c.href=a,c.hostname.replace("www.","").replace("news.","")}});